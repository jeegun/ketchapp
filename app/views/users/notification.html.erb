<div class="container">
  <div class="row">
    <div class="notifications col-12 col-lg-8 offset-lg-2">
      <% @my_notifications.each do |notification| %>
        <% if notification.read_at.nil? %>
          <div class="notification" data-notification-id='<%= notification.id %>'>
        <% else %>
          <div class="notification" data-notification-id='<%= notification.id %>' style="background: white;">
        <% end %>
          <div class="notification-head">
            <img class="avatar" src="https://kitt.lewagon.com/placeholder/users/<%= notification.actor.lewagon_username %>">
            <div class="notification-content">
              <p><small><%= notification.month %> <%= notification.day %>, <%= notification.year %></small></p>
              <p><strong><%= notification.actor.full_name %></strong> <%= notification.action %> <%= notification.notifiable_type.to_s.underscore.humanize.downcase if notification.notifiable_type != 'Trip' %></p>
            </div>
          </div>
          <div class="notification-actions">
            <% if (notification.notifiable_type == 'ConnectRequest') && (notification.action == 'sent you a') && ConnectRequest.find(notification.notifiable_id).status == "pending" %>
              <%= simple_form_for [ConnectRequest.find(notification.notifiable_id), @connection] do |f| %>
                <%= f.submit "Accept", class: "btn btn-flat" %>
              <% end %>
              <%= link_to "Decline", connect_request_path(notification.notifiable_id), data: { confirm: "Are you sure?" }, method: :delete, class: "btn btn-ghost" %>
            <% elsif (notification.notifiable_type == 'Ketchup') && (notification.action == 'has sent you a request to') && Ketchup.find(notification.notifiable_id).status == "pending" %>
              <%= link_to 'Confirm', ketchup_path(Ketchup.find(notification.notifiable_id)), method: :patch || :put, class: 'btn btn-flat' %>
              <%= link_to 'Decline', ketchup_path(Ketchup.find(notification.notifiable_id)), method: :delete, data: {confirm: 'Are you sure?'}, class: 'btn btn-ghost' %>
            <% elsif notification.notifiable_type == 'Trip' %>
              <%= link_to 'Ketchup', '', data: { toggle: "modal", target: "#ketchupCreateModal-#{notification.notifiable_id}" }, class: 'btn btn-flat', id: "ketchup-#{notification.notifiable_id}" %>
              <%= simple_form_for [notification.actor, @chat], html: { id: "new_chat_#{notification.actor.id}" } do |f| %>
                <%= f.submit "Chat", class: 'btn btn-ghost ml-3' %>
              <% end %>
            <% else %>
              <%= link_to notification_path(notification), method: :delete, remote: true do%>
                Dismiss <i class="fas fa-times"></i>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
<% @my_trip_notifications.each do |notification| %>
  <div class="modal fade" id="ketchupCreateModal-<%= notification.notifiable_id %>" tabindex="-1" role="dialog" aria-labelledby="ketchupCreateModalLabel" aria-hidden="true">
    <%= render 'ketchups/form_from_notification', trip: Trip.find(notification.notifiable_id), ketchup: @ketchup, notification: notification %>
  </div>
<% end %>
<script>
  function initMap() {
    <% @my_trip_notifications.each do |notification| %>
      var input<%= notification.notifiable_id %> = document.getElementById('ketchup_location_<%= notification.notifiable_id %>');
      var autocomplete<%= notification.notifiable_id %> = new google.maps.places.Autocomplete(input<%= notification.notifiable_id %>, {types: ['establishment']});
      autocomplete<%= notification.notifiable_id %>.setFields(['geometry', 'name']);
      autocomplete<%= notification.notifiable_id %>.addListener('place_changed', fillInForm<%= notification.notifiable_id %>);
      function fillInForm<%= notification.notifiable_id %>() {
        var place<%= notification.notifiable_id %> = autocomplete<%= notification.notifiable_id %>.getPlace();
        if (!place<%= notification.notifiable_id %>.geometry) {
          // User entered the name of a Place that was not suggested and
          // pressed the Enter key, or the Place Details request failed.
          window.alert("No details available for input: '" + place<%= notification.notifiable_id %>.name + "'");
          return;
        }
        document.getElementById('ketchup_latitude_<%= notification.notifiable_id %>').value = place<%= notification.notifiable_id %>.geometry.location.lat()
        document.getElementById('ketchup_longitude_<%= notification.notifiable_id %>').value = place<%= notification.notifiable_id %>.geometry.location.lng()
      }
    <% end %>
  }
  <% @my_trip_notifications.each do |notification| %>
    $(document).ready(function() {
      $('#ketchup_start_date_<%= notification.notifiable_id %>').daterangepicker({
        singleDatePicker: true,
        timePicker: true,
        timePicker24Hour: true,
        timePickerIncrement: 15,
        startDate: '<%= Trip.find(notification.notifiable_id).start_date.strftime('%b %d, %Y 12:00 PM') %>',
        minDate: '<%= Trip.find(notification.notifiable_id).start_date.strftime('%b %d, %Y %I:%M %p') %>',
        maxDate: '<%= Trip.find(notification.notifiable_id).end_date.strftime('%b %d, %Y 11:30 PM') %>',
        opens: "right",
        locale: {
          format: 'MMM DD, YYYY hh:mm A'
        }
      });
    });
  <% end %>
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API_KEY'] %>&libraries=places&callback=initMap" async defer></script>


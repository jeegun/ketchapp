<div class="container">
  <div class="row">
    <div class="col-12">
      <h1>Trip to <%= @trip.location %> from <%= @start_month %> <%= @start_day %> <%= @start_year if @start_year != @end_year %> to <%= @end_month %> <%= @end_day %> <%= @end_year %></h1>
      <div class="d-flex justify-content-between">
        <div style="flex: 0 0 55%">
          <% if @trip.status == 'saved' %>
            <ul class="list-inline tabs-underlined">
              <!-- tabs without js function need to add js to show the right div -->
              <li>
                <p class="tab-underlined active-tab">People (<%= @people_to_show.count %>)</p>
              </li>
            </ul>
          <% else %>
            <ul class="list-inline tabs-underlined">
              <!-- tabs without js function need to add js to show the right div -->
              <li>
                <p class="tab-underlined active-tab">People (<%= @people_to_show.count %>)</p>
              </li>
              <li>
                <p class="tab-underlined">Ketchups (<%= @trip.ketchups.count %>)</p>
              </li>
              <li>
                <p class="tab-underlined">Calendar</p>
              </li>
            </ul>
          <% end %>
        </div>
        <div>
          <!-- need to remove edit button from saved when confirm function is implemented -->
          <% if @trip.status == 'saved' %>
            <%= link_to 'Delete this search', trip_path(@trip), method: :delete, data: {confirm: 'Are you sure?'}, class: 'btn btn-ghost mt-3 mr-2' %>
            <%= link_to 'Confirm this trip', trip_path(@trip), method: :patch || :put, class: 'btn btn-flat mt-3 mr-2' %>
          <% elsif @trip.status == 'confirmed' %>
            <%= link_to 'Change dates', '', data: { toggle: "modal", target: "#tripEditModal" }, class: 'btn btn-ghost mt-3 mr-2' %>
            <%= link_to 'Delete trip', trip_path(@trip), method: :patch || :put, data: {confirm: 'Delete trip and associated ketchups?'}, class: 'btn btn-ghost mt-3 mr-2' %>
            <%= link_to 'Create another trip', root_path, class: 'btn btn-flat mt-3 mr-2' %>
          <% end %>
        </div>
      </div>
      <!-- connections div -->
      <div class="cards-connections">
        <% @people_to_show.each do |people| %>
              <div class="card-vertical-connection">
                <img src="https://kitt.lewagon.com/placeholder/users/<%= people.lewagon_username %>" />
                <div class="card-vertical-connection-infos">
                  <h3><%= people.full_name %></h3>
                  <!-- <p>Available dates: </p> -->
                  <br>
                </div>
                <div class="card-vertical-connection-btn">
                  <% if current_user.is_connection?(people) %>
                    <%= simple_form_for [people, @chat], html: { id: "new_chat_#{people.id}" } do |f| %>
                      <%= f.submit "Chat", class: 'btn btn-ghost btn-left mb-0' %>
                    <% end %>
                    <%= link_to 'Ketchup', '', data: { toggle: "modal", target: "#createKetchup#{people.id}" }, class: 'btn btn-ghost btn-right mb-0' %>
                  <% elsif current_user.sent_connect_request?(people) %>
                    <button class='btn-ghost btn-center disabled' disabled="disabled">Sent</button>
                  <% elsif current_user.received_connect_request?(people) %>
                    <button class='btn-ghost btn-center disabled' disabled="disabled">Received</button>
                  <% else %>
                    <%= simple_form_for [people, @connect_request], html: { class: 'new_connect_request center', id: "new_connect_request_#{people.id}" } do |f| %>
                      <%= f.submit "Connect request", class: "btn btn-ghost btn-center mb-0" %>
                    <% end %>
                  <% end %>
                  <%#= link_to 'Start a chat', chats_path(user_id: people.id), method: :post, class: 'btn btn-ghost mb-0' %>
                </div>
              </div>
        <% end %>
      </div>
      <% if @trip.status == 'confirmed' %>
        <!-- calendar div -->
        <div class="responsiveCal">
          <iframe
            src="https://calendar.google.com/calendar/embed?src=<%= current_user.email %>&ctz=<%= Time.zone %>"
            style="border: 0" width="800" height="600" frameborder="0" scrolling="no">
          </iframe>
        </div>
        <!-- ketchups div -->
        <div class="ketchups">
          <% if @trip.ketchups.any? %>
            <h3>Pending ketchup</h3>
            <% @trip.ketchups.each do |ketchup| %>
              <% if ketchup.status == 'pending' %>
                <p><%= link_to "Ketchup requested to #{ketchup.user.full_name}", ketchup_path(ketchup) %></p>
              <% end %>
            <% end %>
            <h3>Confirmed ketchup</h3>
            <% @trip.ketchups.each do |ketchup| %>
              <% if ketchup.status == 'confirmed' %>
                <p><%= link_to "Confirmed ketchup with #{ketchup.user.full_name}", ketchup_path(ketchup) %></p>
              <% end %>
            <% end %>
          <% else %>
            <p>No ketchup yet</p>
          <% end %>
          <!-- will be button to open modal once implemented -->
          <%= link_to 'Create new ketchup', '#' %>
          <!-- will move this from to modal -->
          <%= form_with model: [@trip, @ketchup], local: true, id: 'ketchup-form' do |form| %>
            <div class="form-group">
              <%= form.label 'Choose a connection to ketchup with:' %>
              <%= form.collection_select :user_id, @people_in_radius_are_connections, :id, :full_name, class: 'form-control' %>
            </div>

            <div class="form-group">
              <%= form.label 'Start date & time (UTC)' %>
              <%= form.text_field :start_date, class: 'daterange form-control' %>
            </div>

            <div class="form-group">
              <%= form.label 'Duration (in min)' %>
              <%= form.text_field :duration, type: "number", value: 30, min: 30, step: 15, class: 'form-control' %>
            </div>

            <div class="form-group">
              <%= form.label "Where do you want to Ketchup" %>
              <%= form.text_field :location, class: 'form-control', onkeypress: "return event.keyCode!=13" %>
              <%= form.text_field :latitude, type: "hidden", class: 'form-control' %>
              <%= form.text_field :longitude, type: "hidden", class: 'form-control' %>
            </div>

            <div class="form-group">
              <%= form.label :message %>
              <%= form.text_area :message, class: 'form-control' %>
            </div>

            <div class="actions">
              <%= form.submit "Send ketchup request", class: 'btn btn-flat' %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
<div class="modal fade" id="tripEditModal" tabindex="-1" role="dialog" aria-labelledby="tripEditModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tripEditModalLabel">Change dates</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-left">
        <%= simple_form_for @trip do |f| %>
          <%= f.input :start_date %>
          <%= f.input :end_date %>
      </div>
      <div class="modal-footer">
        <%= f.button :submit, 'Confirm', class: 'btn-flat' %>
        <%= link_to 'Cancel trip', trip_path(@trip), method: :delete, data: {confirm: 'Are you sure?'}, class: 'btn btn-ghost', style: 'margin-left:16px; border-radius: 4px !important;' %>
        <% end %>
      </div>
    </div>
  </div>
</div>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API_KEY'] %>&libraries=places&callback=initMap" async defer></script>
<script>
  form = document.getElementById('ketchup-form');
  function initMap() {
    if (form) {
      let input = document.getElementById('ketchup_location');
      let autocomplete = new google.maps.places.Autocomplete(input, {types: ['establishment']});
      autocomplete.setFields(['geometry', 'name']);
      autocomplete.addListener('place_changed', fillInForm);
      function fillInForm() {
        let place = autocomplete.getPlace();
        if (!place.geometry) {
          // User entered the name of a Place that was not suggested and
          // pressed the Enter key, or the Place Details request failed.
          window.alert("No details available for input: '" + place.name + "'");
          return;
        }
        document.getElementById('ketchup_latitude').value = place.geometry.location.lat()
        document.getElementById('ketchup_longitude').value = place.geometry.location.lng()
      }
    }
  }
  $(document).ready(function() {
    $('input[class="daterange form-control"]').daterangepicker({
      singleDatePicker: true,
      timePicker: true,
      timePicker24Hour: true,
      timePickerIncrement: 15,
      startDate: '<%= @default_date %>',
      minDate: '<%= @start_date %>',
      maxDate: '<%= @end_date %>',
      opens: "right",
      locale: {
        format: 'MMM DD, YYYY hh:mm A'
      }
    });
  });
</script>
